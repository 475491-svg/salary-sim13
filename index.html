<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¡×™××•×œ×˜×•×¨ ×ª×§×¦×™×‘ ×§×™×“×•× ×¢×•×‘×“×™×</title>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2B4C7E;
            --primary-light: #567BA6;
            --primary-dark: #1A2F4F;
            --accent: #D4AF37;
            --success: #2D8659;
            --warning: #E67E22;
            --danger: #C0392B;
            --bg: #F8F9FA;
            --card-bg: #FFFFFF;
            --text: #2C3E50;
            --text-light: #7F8C8D;
            --border: #E0E4E8;
            --shadow: rgba(43, 76, 126, 0.08);
            --shadow-hover: rgba(43, 76, 126, 0.15);
        }

        body {
            font-family: 'Assistant', 'Heebo', sans-serif;
            background: linear-gradient(135deg, #F8F9FA 0%, #E8EDF2 100%);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            padding: 2rem 1rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 20px 60px var(--shadow);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 3rem 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            border-radius: 50%;
        }

        .header h1 {
            font-family: 'Heebo', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.95;
            position: relative;
            z-index: 1;
        }

        .progress-bar {
            display: flex;
            justify-content: space-between;
            padding: 2rem 3rem;
            background: white;
            border-bottom: 2px solid var(--border);
            position: relative;
        }

        .progress-step {
            flex: 1;
            text-align: center;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .progress-step::before {
            content: '';
            position: absolute;
            top: 25px;
            right: 50%;
            width: 100%;
            height: 3px;
            background: var(--border);
            z-index: 0;
        }

        .progress-step:first-child::before {
            display: none;
        }

        .progress-step.active::before,
        .progress-step.completed::before {
            background: var(--primary);
        }

        .step-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--bg);
            border: 3px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.75rem;
            font-weight: 700;
            font-size: 1.2rem;
            position: relative;
            z-index: 1;
            transition: all 0.3s ease;
        }

        .progress-step.active .step-circle {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: scale(1.1);
            box-shadow: 0 4px 15px var(--shadow-hover);
        }

        .progress-step.completed .step-circle {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .progress-step.completed .step-circle::after {
            content: 'âœ“';
            font-size: 1.5rem;
        }

        .step-label {
            font-weight: 600;
            color: var(--text-light);
            font-size: 0.95rem;
            transition: color 0.3s ease;
        }

        .progress-step.active .step-label {
            color: var(--primary);
            font-weight: 700;
        }

        .content {
            padding: 3rem;
        }

        .step-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .step-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .section-title::before {
            content: '';
            width: 5px;
            height: 35px;
            background: var(--accent);
            border-radius: 3px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            font-weight: 600;
            color: var(--text);
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-label .required {
            color: var(--danger);
            font-size: 1.2rem;
        }

        .form-input,
        .form-select {
            padding: 0.9rem 1.2rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            font-family: 'Assistant', sans-serif;
            transition: all 0.3s ease;
            background: white;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(43, 76, 126, 0.1);
        }

        .form-input:disabled {
            background: var(--bg);
            cursor: not-allowed;
        }

        .info-box {
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            border-right: 4px solid var(--primary);
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            color: var(--primary-dark);
        }

        .info-box h3 {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
        }

        .info-box ul {
            margin-right: 1.5rem;
        }

        .info-box li {
            margin-bottom: 0.5rem;
        }

        .criteria-card {
            background: var(--bg);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            border: 2px solid var(--border);
            position: relative;
            transition: all 0.3s ease;
        }

        .criteria-card:hover {
            border-color: var(--primary-light);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .criteria-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .criteria-number {
            background: var(--primary);
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .remove-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .remove-btn:hover {
            background: #A93226;
            transform: scale(1.05);
        }

        .weight-display {
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
            padding: 1.5rem;
            background: var(--bg);
            border-radius: 12px;
            margin: 1.5rem 0;
            border: 3px solid var(--border);
            transition: all 0.3s ease;
        }

        .weight-display.valid {
            border-color: var(--success);
            color: var(--success);
        }

        .weight-display.invalid {
            border-color: var(--danger);
            color: var(--danger);
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-size: 1.05rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Assistant', sans-serif;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px var(--shadow-hover);
        }

        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--primary);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #27AE60;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: space-between;
        }

        .add-btn {
            background: var(--accent);
            color: var(--primary-dark);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s ease;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .add-btn:hover:not(:disabled) {
            background: #C19B2B;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }

        .add-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .employee-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .employee-table thead {
            background: var(--primary);
            color: white;
        }

        .employee-table th,
        .employee-table td {
            padding: 1rem;
            text-align: right;
            border-bottom: 1px solid var(--border);
        }

        .employee-table th {
            font-weight: 700;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .employee-table tbody tr {
            transition: all 0.3s ease;
        }

        .employee-table tbody tr:hover {
            background: var(--bg);
        }

        .employee-table input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            text-align: center;
            font-size: 0.95rem;
        }

        .employee-table input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(43, 76, 126, 0.1);
        }

        #inputTable {
            border: 3px solid var(--primary-light);
            box-shadow: 0 4px 12px var(--shadow);
        }

        #inputTable thead {
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
        }

        #inputTable tbody tr {
            background: linear-gradient(135deg, rgba(43, 76, 126, 0.03) 0%, rgba(86, 123, 166, 0.03) 100%);
        }

        #inputTable input::placeholder {
            color: var(--text-light);
            opacity: 0.6;
        }

        .action-btn {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 1.3rem;
            padding: 0.25rem 0.5rem;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            transform: scale(1.2);
        }

        .upload-area {
            border: 3px dashed var(--border);
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            background: var(--bg);
            transition: all 0.3s ease;
            cursor: pointer;
            margin: 1.5rem 0;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: rgba(43, 76, 126, 0.05);
        }

        .upload-area.dragover {
            border-color: var(--primary);
            background: rgba(43, 76, 126, 0.1);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--primary-light);
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--card-bg) 0%, var(--bg) 100%);
            padding: 1.5rem;
            border-radius: 12px;
            border: 2px solid var(--border);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px var(--shadow);
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-light);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .alert {
            padding: 1rem 1.5rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            animation: slideIn 0.4s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .alert-error {
            background: #FADBD8;
            color: var(--danger);
            border-right: 4px solid var(--danger);
        }

        .alert-warning {
            background: #FCF3CF;
            color: #B8860B;
            border-right: 4px solid var(--warning);
        }

        .alert-success {
            background: #D5F4E6;
            color: var(--success);
            border-right: 4px solid var(--success);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2.5rem;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 1.5rem;
        }

        .tab-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: var(--bg);
            padding: 0.5rem;
            border-radius: 12px;
        }

        .tab-btn {
            flex: 1;
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            color: var(--text-light);
        }

        .tab-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 2px 8px var(--shadow);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            transition: background 0.3s ease;
        }

        .summary-item:hover {
            background: var(--bg);
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            font-weight: 600;
            color: var(--text);
        }

        .summary-value {
            font-weight: 700;
            color: var(--primary);
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            .progress-bar,
            .btn-group,
            .no-print {
                display: none !important;
            }
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-light);
        }

        .spinner {
            border: 4px solid var(--border);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            color: var(--primary-light);
            margin-right: 0.5rem;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.5rem 1rem;
            background: var(--primary-dark);
            color: white;
            border-radius: 6px;
            white-space: nowrap;
            font-size: 0.85rem;
            z-index: 100;
        }

        .custom-checkbox {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: background 0.3s ease;
        }

        .custom-checkbox:hover {
            background: var(--bg);
        }

        .custom-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .export-options {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>×¡×™××•×œ×˜×•×¨ ×ª×§×¦×™×‘ ×§×™×“×•× ×¢×•×‘×“×™×</h1>
            <p>××¢×¨×›×ª ××ª×§×“××ª ×œ×—×™×©×•×‘ ×•× ×™×”×•×œ ×ª×§×¦×™×‘ ×§×™×“×•× ×‘××¨×’×•×Ÿ</p>
        </div>

        <div class="progress-bar">
            <div class="progress-step active" data-step="1">
                <div class="step-circle">1</div>
                <div class="step-label">×”×’×“×¨×•×ª ×‘×¡×™×¡</div>
            </div>
            <div class="progress-step" data-step="2">
                <div class="step-circle">2</div>
                <div class="step-label">×”×’×“×¨×ª ××“×“×™×</div>
            </div>
            <div class="progress-step" data-step="3">
                <div class="step-circle">3</div>
                <div class="step-label">×”×–× ×ª ×¢×•×‘×“×™×</div>
            </div>
            <div class="progress-step" data-step="4">
                <div class="step-circle">4</div>
                <div class="step-label">×ª×•×¦××•×ª</div>
            </div>
        </div>

        <div class="content">
            <!-- Step 1: Base Settings -->
            <div class="step-content active" data-step="1">
                <h2 class="section-title">×”×’×“×¨×•×ª ×‘×¡×™×¡ ×œ×—×™×©×•×‘ ×ª×§×¦×™×‘ ×§×™×“×•×</h2>
                
                <div class="info-box">
                    <h3>×§×¨×™×˜×¨×™×•× ×™× ×œ×–×›××•×ª ×œ×ª×§×¦×™×‘ ×§×™×“×•×:</h3>
                    <ul>
                        <li>×¢×•×‘×“ ×œ× ×‘×›×™×¨ (×¡×¢×™×£ 4.1 ×‘×—×•×–×¨ ×× ×›"×œ)</li>
                        <li>×•×ª×§ ××¢×œ ×—×¦×™ ×©× ×” (×¡×¢×™×£ 4.8 ×‘×—×•×–×¨ ×× ×›"×œ)</li>
                        <li>×”×¢×•×‘×“ ×œ× ×¢×‘×¨ ×œ×§×‘×œ×ª ××©×›×•×¨×ª ×‘×˜×•×•×— ×©×›×¨ ×’×‘×•×” ×™×•×ª×¨ (×¡×¢×™×£ 4.12 ×‘×—×•×–×¨ ×× ×›"×œ)</li>
                    </ul>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">
                            <span class="tooltip" data-tooltip="×©×›×¨ ×‘×’×™×Ÿ ×”×¨×›×™×‘×™× ×”××¨×›×™×‘×™× ××ª ×¢×¨×š ×©×¢×ª ×”×¢×•×‘×“">â„¹ï¸</span>
                            ×©×›×¨ ×‘×’×™×Ÿ ×¨×›×™×‘×™ ×¢×¨×š ×©×¢×” (â‚ª)
                            <span class="required">*</span>
                        </label>
                        <input type="number" class="form-input" id="salaryA" placeholder="×”×–×Ÿ ×¡×›×•×" min="0" step="0.01">
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <span class="tooltip" data-tooltip="×©×›×¨ ×©×©×•×œ× ×‘×’×™×Ÿ ×¢×‘×•×“×” × ×•×¡×¤×ª">â„¹ï¸</span>
                            ×©×›×¨ ×‘×’×™×Ÿ ×¢×‘×•×“×” × ×•×¡×¤×ª (â‚ª)
                            <span class="required">*</span>
                        </label>
                        <input type="number" class="form-input" id="salaryB" placeholder="×”×–×Ÿ ×¡×›×•×" min="0" step="0.01">
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <span class="tooltip" data-tooltip="×”×©×™×¢×•×¨ ×©× ×§×‘×¢ ×¢×œ ×™×“×™ ××©×¨×“ ×”××•×¦×¨">â„¹ï¸</span>
                            ×©×™×¢×•×¨ ×ª×§×¦×™×‘ ×”×§×™×“×•× (%)
                            <span class="required">*</span>
                        </label>
                        <input type="number" class="form-input" id="budgetRate" placeholder="×”×–×Ÿ ××—×•×–" min="0" max="100" step="0.01">
                    </div>

                    <div class="form-group">
                        <label class="form-label">×¡×š ×”×›×œ ×ª×§×¦×™×‘ ×”×‘×¡×™×¡ (â‚ª)</label>
                        <input type="text" class="form-input" id="totalBaseBudget" disabled value="0">
                    </div>

                    <div class="form-group">
                        <label class="form-label">×”×™×—×¡</label>
                        <input type="text" class="form-input" id="ratio" disabled value="0">
                    </div>

                    <div class="form-group">
                        <label class="form-label">××§×“× ×”×”×¤×—×ª×”</label>
                        <input type="text" class="form-input" id="reductionFactor" disabled value="0">
                    </div>
                </div>

                <div class="btn-group">
                    <div></div>
                    <button class="btn btn-primary" onclick="nextStep()" id="step1Next">×”××©×š ×œ×©×œ×‘ ×”×‘× â†</button>
                </div>
            </div>

            <!-- Step 2: Criteria Setup -->
            <div class="step-content" data-step="2">
                <h2 class="section-title">×”×’×“×¨×ª ××“×“×™ ×”×¢×¨×›×”</h2>

                <div class="info-box">
                    <h3>×”× ×—×™×•×ª ×œ××“×“×™ ×”×¢×¨×›×”:</h3>
                    <ul>
                        <li>×™×© ×œ×”×’×“×™×¨ ×‘×™×Ÿ 1 ×œ-10 ××“×“×™× ×œ×”×¢×¨×›×ª ×¢×•×‘×“×™×</li>
                        <li>×¡×š ×›×œ ×”××©×§×•×œ×•×ª ×—×™×™×‘ ×œ×”×¡×ª×›× ×œ-100%</li>
                        <li>×˜×•×•×— ×”×¦×™×•× ×™× ×œ×›×œ ××“×“: 1-5</li>
                        <li>× ×™×ª×Ÿ ×œ×‘×—×•×¨ ××“×“ ××”×¨×©×™××” ××• ×œ×”×•×¡×™×£ ××“×“ ××•×ª×× ××™×©×™×ª</li>
                    </ul>
                </div>

                <div class="weight-display" id="weightDisplay">
                    ×¡×š ××©×§×•×œ×•×ª: <span id="totalWeight">0</span>%
                </div>

                <div id="criteriaContainer"></div>

                <button class="add-btn" onclick="addCriteria()" id="addCriteriaBtn">
                    â• ×”×•×¡×£ ××“×“ × ×•×¡×£
                </button>

                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="prevStep()">â†’ ×—×–×•×¨</button>
                    <button class="btn btn-primary" onclick="nextStep()" id="step2Next" disabled>×”××©×š ×œ×©×œ×‘ ×”×‘× â†</button>
                </div>
            </div>

            <!-- Step 3: Employee Data -->
            <div class="step-content" data-step="3">
                <h2 class="section-title">×”×–× ×ª × ×ª×•× ×™ ×¢×•×‘×“×™×</h2>

                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="switchTab('manual')">×”×–× ×” ×™×“× ×™×ª</button>
                    <button class="tab-btn" onclick="switchTab('upload')">×”×¢×œ××ª ×§×•×‘×¥ Excel</button>
                </div>

                <div class="tab-content active" id="manualTab">
                    <div class="info-box" style="background: linear-gradient(135deg, #FFF3CD 0%, #FCE4A6 100%); border-right-color: var(--accent);">
                        <h3>ğŸ’¡ ×”× ×—×™×•×ª ×œ×”×–× ×”:</h3>
                        <ul>
                            <li>××œ× ××ª ×›×œ ×”×©×“×•×ª ×‘×©×•×¨×” ×•×œ×—×¥ ×¢×œ ×›×¤×ª×•×¨ "×”×•×¡×£ ×¢×•×‘×“"</li>
                            <li>×¦×™×•× ×™ ×”××“×“×™× ×‘×˜×•×•×— 1-5</li>
                            <li>× ×™×ª×Ÿ ×œ×”×•×¡×™×£ ×¢×•×‘×“×™× × ×•×¡×¤×™× ×‘×¨×¦×£</li>
                        </ul>
                    </div>

                    <div style="overflow-x: auto; margin-bottom: 1.5rem;">
                        <table class="employee-table" id="inputTable" style="background: white;">
                            <thead>
                                <tr>
                                    <th style="min-width: 150px;">×©× ×¢×•×‘×“ <span class="required">*</span></th>
                                    <th style="min-width: 120px;">××¡×¤×¨ ×–×”×•×ª <span class="required">*</span></th>
                                    <th style="min-width: 120px;">××©×›×•×¨×ª (â‚ª) <span class="required">*</span></th>
                                    <th id="inputScoresHeader"></th>
                                    <th style="min-width: 100px;">×¤×¢×•×œ×”</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr id="inputRow">
                                    <td><input type="text" class="form-input" id="employeeName" placeholder="×©× ××œ×" style="margin: 0;"></td>
                                    <td><input type="text" class="form-input" id="employeeId" placeholder="×ª.×–." style="margin: 0;"></td>
                                    <td><input type="number" class="form-input" id="employeeSalary" placeholder="××©×›×•×¨×ª" min="0" step="0.01" style="margin: 0;"></td>
                                    <td id="inputScoresContainer" style="padding: 0.5rem;"></td>
                                    <td>
                                        <button class="add-btn" onclick="addEmployee()" style="width: 100%; margin: 0;">
                                            â• ×”×•×¡×£
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-content" id="uploadTab">
                    <div class="info-box" style="background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%); border-right-color: var(--success);">
                        <h3>ğŸ“‹ ×“×¨×™×©×•×ª ×œ×§×•×‘×¥ Excel:</h3>
                        <ul>
                            <li><strong>×—×•×‘×”:</strong> 3 ×¢××•×“×•×ª - ×©× ×¢×•×‘×“, ××¡×¤×¨ ×–×”×•×ª, ××©×›×•×¨×ª</li>
                            <li>×©××•×ª ×”×¢××•×“×•×ª ×™×›×•×œ×™× ×œ×”×™×•×ª ×‘×¢×‘×¨×™×ª ××• ×× ×’×œ×™×ª</li>
                            <li>×“×•×’×××•×ª ×œ×©××•×ª ×¢××•×“×•×ª ×ª×§×™× ×™×:
                                <ul style="margin-top: 0.5rem;">
                                    <li>×©× ×¢×•×‘×“ / name / ×©×</li>
                                    <li>××¡×¤×¨ ×–×”×•×ª / id / ×ª.×– / ×ª×–</li>
                                    <li>××©×›×•×¨×ª / salary / ×©×›×¨</li>
                                </ul>
                            </li>
                            <li>×”×¦×™×•× ×™× ×©×œ ×”××“×“×™× ×™×ª×•×•×¡×¤×• ××•×˜×•××˜×™×ª ×›-0 ×•× ×™×ª×Ÿ ×œ×¢×¨×•×š ×‘×˜×‘×œ×”</li>
                        </ul>
                    </div>

                    <div style="margin-bottom: 1.5rem; text-align: center;">
                        <button class="btn btn-secondary" onclick="downloadExcelTemplate()" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                            ğŸ“¥ ×”×•×¨×“ ×ª×‘× ×™×ª Excel ×œ×“×•×’××”
                        </button>
                    </div>

                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                        <div class="upload-icon">ğŸ“</div>
                        <h3>×’×¨×•×¨ ×§×•×‘×¥ Excel ×œ×›××Ÿ ××• ×œ×—×¥ ×œ×‘×—×™×¨×”</h3>
                        <p style="color: var(--text-light); margin-top: 0.5rem;">
                            ×ª×•××š ×‘×§×‘×¦×™ .xlsx ×•-.xls
                        </p>
                    </div>
                    <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;" onchange="handleFileUpload(event)">
                </div>

                <div style="margin-top: 2rem;">
                    <h3 style="color: var(--primary); margin-bottom: 1rem; font-size: 1.3rem;">
                        ×¨×©×™××ª ×¢×•×‘×“×™× ×©×”×•×–× ×•: <span style="color: var(--accent);" id="employeeCount">0</span>
                    </h3>
                    <div style="overflow-x: auto;">
                        <table class="employee-table" id="employeeTable">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>×©× ×¢×•×‘×“</th>
                                    <th>××¡×¤×¨ ×–×”×•×ª</th>
                                    <th>××©×›×•×¨×ª (â‚ª)</th>
                                    <th id="scoresHeader"></th>
                                    <th>×¤×¢×•×œ×•×ª</th>
                                </tr>
                            </thead>
                            <tbody id="employeeTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="prevStep()">â†’ ×—×–×•×¨</button>
                    <button class="btn btn-primary" onclick="nextStep()" id="step3Next" disabled>×¦×¤×” ×‘×ª×•×¦××•×ª â†</button>
                </div>
            </div>

            <!-- Step 4: Results -->
            <div class="step-content" data-step="4">
                <h2 class="section-title">×ª×•×¦××•×ª ×•×¡×™×›×•×</h2>

                <div class="results-grid">
                    <div class="stat-card">
                        <div class="stat-label">×¡×š ×ª×§×¦×™×‘ ×§×™×“×•× ×–××™×Ÿ</div>
                        <div class="stat-value" id="totalBudgetAvailable">â‚ª0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">×ª×§×¦×™×‘ ×©×©×™××© ×‘×¤×•×¢×œ</div>
                        <div class="stat-value" id="totalBudgetUsed">â‚ª0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">×™×ª×¨×ª ×ª×§×¦×™×‘</div>
                        <div class="stat-value" id="budgetRemaining">â‚ª0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">××¡×¤×¨ ×¢×•×‘×“×™×</div>
                        <div class="stat-value" id="totalEmployees">0</div>
                    </div>
                </div>

                <div style="overflow-x: auto; margin: 2rem 0;">
                    <table class="employee-table" id="resultsTable">
                        <thead>
                            <tr>
                                <th>×©× ×¢×•×‘×“</th>
                                <th>××¡×¤×¨ ×–×”×•×ª</th>
                                <th>××©×›×•×¨×ª (â‚ª)</th>
                                <th>×¦×™×•×Ÿ ××©×•×§×œ×œ</th>
                                <th>×ª×§×¦×™×‘ ×œ×œ× ××’×‘×œ×” (â‚ª)</th>
                                <th>××—×•×– ×§×™×“×•×</th>
                                <th>×ª×§×¦×™×‘ ×œ××—×¨ ××’×‘×œ×ª 5% (â‚ª)</th>
                                <th>××—×•×– ×§×™×“×•× ×‘×¤×•×¢×œ</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody"></tbody>
                    </table>
                </div>

                <div class="export-options no-print">
                    <button class="btn btn-success" onclick="exportToPDF()">
                        ğŸ“„ ×™×™×¦× ×œ-PDF
                    </button>
                    <button class="btn btn-success" onclick="exportToExcel()">
                        ğŸ“Š ×™×™×¦× ×œ-Excel
                    </button>
                    <button class="btn btn-secondary" onclick="resetSimulator()">
                        ğŸ”„ ×”×ª×—×œ ××—×“×©
                    </button>
                </div>

                <div class="btn-group" style="margin-top: 2rem;">
                    <button class="btn btn-secondary" onclick="prevStep()">â†’ ×—×–×•×¨ ×œ×¢×¨×™×›×”</button>
                    <div></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data storage
        let currentStep = 1;
        let baseSettings = {};
        let criteria = [];
        let employees = [];
        
        // Predefined criteria list
        const predefinedCriteria = [
            '××™×›×•×ª ×¢×‘×•×“×”',
            '×¢××™×“×” ×‘×™×¢×“×™×',
            '×™×•×–××” ×•×—×“×©× ×•×ª',
            '×¢×‘×•×“×ª ×¦×•×•×ª ×•×©×™×ª×•×£ ×¤×¢×•×œ×”',
            '××§×¦×•×¢×™×•×ª ×•××•××—×™×•×ª',
            '×™×—×¡×™ ×× ×•×© ×•×ª×§×©×•×¨×ª',
            '×××™× ×•×ª ×•××—×•×™×‘×•×ª',
            '×™×›×•×œ×ª × ×™×”×•×œ ×–××Ÿ',
            '×œ××™×“×” ×•×”×ª×¤×ª×—×•×ª ××§×¦×•×¢×™×ª',
            '×ª×¨×•××” ×œ××¨×’×•×Ÿ'
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeCriteria();
            updateCalculations();
            
            // Add event listeners for base settings
            ['salaryA', 'salaryB', 'budgetRate'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateCalculations);
            });

            // Setup drag and drop
            const uploadArea = document.getElementById('uploadArea');
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => uploadArea.classList.add('dragover'), false);
            });
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('dragover'), false);
            });
            uploadArea.addEventListener('drop', handleDrop, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                handleFileUpload({ target: { files: files } });
            }
        }

        // Update calculations
        function updateCalculations() {
            const salaryA = parseFloat(document.getElementById('salaryA').value) || 0;
            const salaryB = parseFloat(document.getElementById('salaryB').value) || 0;
            const budgetRate = parseFloat(document.getElementById('budgetRate').value) || 0;

            const totalBaseBudget = salaryA + salaryB;
            const ratio = salaryA > 0 ? totalBaseBudget / salaryA : 0;
            const reductionFactor = ratio > 0 ? (budgetRate / 100) / ratio : 0;

            document.getElementById('totalBaseBudget').value = formatNumber(totalBaseBudget);
            document.getElementById('ratio').value = ratio.toFixed(4);
            document.getElementById('reductionFactor').value = reductionFactor.toFixed(4);

            baseSettings = {
                salaryA,
                salaryB,
                budgetRate,
                totalBaseBudget,
                ratio,
                reductionFactor
            };

            validateStep1();
        }

        function validateStep1() {
            const valid = baseSettings.salaryA > 0 && 
                         baseSettings.salaryB >= 0 && 
                         baseSettings.budgetRate > 0;
            document.getElementById('step1Next').disabled = !valid;
        }

        // Initialize criteria
        function initializeCriteria() {
            criteria = [];
            for (let i = 0; i < 4; i++) {
                addCriteria();
            }
        }

        // Add criteria
        function addCriteria() {
            if (criteria.length >= 10) {
                showAlert('error', '× ×™×ª×Ÿ ×œ×”×•×¡×™×£ ×¢×“ 10 ××“×“×™× ×‘×œ×‘×“');
                return;
            }

            const index = criteria.length;
            const criterion = {
                id: Date.now() + index,
                name: '',
                weight: 0,
                isCustom: false
            };
            criteria.push(criterion);

            renderCriteria();
            updateWeightDisplay();
        }

        // Remove criteria
        function removeCriteria(id) {
            if (criteria.length <= 1) {
                showAlert('error', '×—×™×™×‘ ×œ×”×™×•×ª ×œ×¤×—×•×ª ××“×“ ××—×“');
                return;
            }
            criteria = criteria.filter(c => c.id !== id);
            renderCriteria();
            updateWeightDisplay();
        }

        // Render criteria
        function renderCriteria() {
            const container = document.getElementById('criteriaContainer');
            container.innerHTML = '';

            criteria.forEach((criterion, index) => {
                const card = document.createElement('div');
                card.className = 'criteria-card';
                card.innerHTML = `
                    <div class="criteria-header">
                        <div class="criteria-number">${index + 1}</div>
                        ${criteria.length > 1 ? `<button class="remove-btn" onclick="removeCriteria(${criterion.id})">ğŸ—‘ï¸ ×”×¡×¨</button>` : ''}
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">×©× ×”××“×“ <span class="required">*</span></label>
                            <select class="form-select" id="criteriaSelect_${criterion.id}" onchange="handleCriteriaSelect(${criterion.id}, this.value)">
                                <option value="">×‘×—×¨ ××“×“ ××”×¨×©×™××”</option>
                                ${predefinedCriteria.map(c => `<option value="${c}" ${criterion.name === c ? 'selected' : ''}>${c}</option>`).join('')}
                                <option value="custom" ${criterion.isCustom ? 'selected' : ''}>××“×“ ××•×ª×× ××™×©×™×ª</option>
                            </select>
                        </div>
                        <div class="form-group" id="customCriteriaGroup_${criterion.id}" style="display: ${criterion.isCustom ? 'flex' : 'none'}">
                            <label class="form-label">×©× ×”××“×“ ×”××•×ª×× <span class="required">*</span></label>
                            <input type="text" class="form-input" id="customCriteria_${criterion.id}" 
                                   value="${criterion.isCustom ? criterion.name : ''}" 
                                   onchange="updateCustomCriteria(${criterion.id}, this.value)"
                                   placeholder="×”×–×Ÿ ×©× ××“×“">
                        </div>
                        <div class="form-group">
                            <label class="form-label">××©×§×œ (%) <span class="required">*</span></label>
                            <input type="number" class="form-input" id="weight_${criterion.id}" 
                                   value="${criterion.weight}" 
                                   onchange="updateWeight(${criterion.id}, this.value)"
                                   min="0" max="100" step="0.1" placeholder="×”×–×Ÿ ××©×§×œ">
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });

            document.getElementById('addCriteriaBtn').disabled = criteria.length >= 10;
        }

        // Handle criteria selection
        function handleCriteriaSelect(id, value) {
            const criterion = criteria.find(c => c.id === id);
            if (value === 'custom') {
                criterion.isCustom = true;
                criterion.name = '';
                document.getElementById(`customCriteriaGroup_${id}`).style.display = 'flex';
            } else {
                criterion.isCustom = false;
                criterion.name = value;
                document.getElementById(`customCriteriaGroup_${id}`).style.display = 'none';
            }
            validateStep2();
        }

        // Update custom criteria
        function updateCustomCriteria(id, value) {
            const criterion = criteria.find(c => c.id === id);
            criterion.name = value;
            validateStep2();
        }

        // Update weight
        function updateWeight(id, value) {
            const criterion = criteria.find(c => c.id === id);
            criterion.weight = parseFloat(value) || 0;
            updateWeightDisplay();
            validateStep2();
        }

        // Update weight display
        function updateWeightDisplay() {
            const total = criteria.reduce((sum, c) => sum + c.weight, 0);
            const display = document.getElementById('weightDisplay');
            const totalSpan = document.getElementById('totalWeight');
            
            totalSpan.textContent = total.toFixed(1);
            
            display.classList.remove('valid', 'invalid');
            if (Math.abs(total - 100) < 0.01) {
                display.classList.add('valid');
            } else {
                display.classList.add('invalid');
            }
        }

        // Validate step 2
        function validateStep2() {
            const totalWeight = criteria.reduce((sum, c) => sum + c.weight, 0);
            const allNamed = criteria.every(c => c.name && c.name.trim() !== '');
            const weightsValid = Math.abs(totalWeight - 100) < 0.01;
            
            const valid = allNamed && weightsValid;
            document.getElementById('step2Next').disabled = !valid;
            
            if (!weightsValid && allNamed) {
                if (totalWeight > 100) {
                    showAlert('warning', '×¡×š ×”××©×§×•×œ×•×ª ×¢×•×œ×” ×¢×œ 100%');
                } else if (totalWeight < 100) {
                    showAlert('warning', '×¡×š ×”××©×§×•×œ×•×ª × ××•×š ×-100%');
                }
            }
        }

        // Add employee
        function addEmployee() {
            const name = document.getElementById('employeeName').value.trim();
            const id = document.getElementById('employeeId').value.trim();
            const salary = parseFloat(document.getElementById('employeeSalary').value) || 0;

            if (!name || !id || salary <= 0) {
                showAlert('error', '×™×© ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª ×”×‘×¡×™×¡×™×™× (×©×, ×ª.×–., ××©×›×•×¨×ª)');
                return;
            }

            // Check for duplicate ID
            if (employees.some(e => e.id === id)) {
                showAlert('error', '××¡×¤×¨ ×–×”×•×ª ×–×” ×›×‘×¨ ×§×™×™× ×‘××¢×¨×›×ª');
                return;
            }

            // Collect and validate scores
            const scores = {};
            let allScoresValid = true;
            criteria.forEach(c => {
                const scoreInput = document.getElementById(`score_${c.id}`);
                const score = parseFloat(scoreInput.value);
                
                if (!score || score < 1 || score > 5) {
                    allScoresValid = false;
                }
                scores[c.id] = score || 0;
            });

            if (!allScoresValid) {
                showAlert('error', '×™×© ×œ××œ× ××ª ×›×œ ×¦×™×•× ×™ ×”××“×“×™× (1-5)');
                return;
            }

            employees.push({ name, id, salary, scores });

            // Clear form
            document.getElementById('employeeName').value = '';
            document.getElementById('employeeId').value = '';
            document.getElementById('employeeSalary').value = '';
            criteria.forEach(c => {
                document.getElementById(`score_${c.id}`).value = '';
            });

            // Focus back on first field for quick data entry
            document.getElementById('employeeName').focus();

            renderEmployeeTable();
            validateStep3();
            showAlert('success', `âœ“ ×”×¢×•×‘×“ ${name} × ×•×¡×£ ×‘×”×¦×œ×—×”!`);
        }

        // Download Excel template
        function downloadExcelTemplate() {
            const templateData = [
                ['×©× ×¢×•×‘×“', '××¡×¤×¨ ×–×”×•×ª', '××©×›×•×¨×ª'],
                ['×“× ×™ ×›×”×Ÿ', '123456789', '15000'],
                ['×©×¨×” ×œ×•×™', '987654321', '18000'],
                ['×™×•×¡×™ ××–×¨×—×™', '456789123', '16500']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            
            // Set column widths
            ws['!cols'] = [
                { wch: 20 },
                { wch: 15 },
                { wch: 15 }
            ];
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, '×¢×•×‘×“×™×');
            
            XLSX.writeFile(wb, '×ª×‘× ×™×ª_×¢×•×‘×“×™×.xlsx');
            showAlert('success', 'âœ“ ×ª×‘× ×™×ª Excel ×”×•×¨×“×” ×‘×”×¦×œ×—×”!');
        }

        // Add keyboard shortcut for quick employee addition
        document.addEventListener('DOMContentLoaded', function() {
            // Listen for Enter key in input fields of step 3
            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && currentStep === 3) {
                    const activeTab = document.querySelector('.tab-content.active');
                    if (activeTab && activeTab.id === 'manualTab') {
                        addEmployee();
                    }
                }
            });
        });

        // Remove employee
        function removeEmployee(id) {
            employees = employees.filter(e => e.id !== id);
            renderEmployeeTable();
            validateStep3();
        }

        // Render employee table
        function renderEmployeeTable() {
            const tbody = document.getElementById('employeeTableBody');
            const scoresHeader = document.getElementById('scoresHeader');
            const employeeCountSpan = document.getElementById('employeeCount');
            
            // Update header
            scoresHeader.innerHTML = '';
            criteria.forEach(c => {
                const th = document.createElement('th');
                th.textContent = c.name;
                scoresHeader.appendChild(th);
            });

            // Update count
            if (employeeCountSpan) {
                employeeCountSpan.textContent = employees.length;
            }

            tbody.innerHTML = '';
            employees.forEach((emp, index) => {
                const row = document.createElement('tr');
                
                // Create cells array with row number
                const cells = [
                    `<td style="font-weight: 700; color: var(--primary);">${index + 1}</td>`,
                    `<td>${emp.name}</td>`,
                    `<td>${emp.id}</td>`,
                    `<td>${formatNumber(emp.salary)}</td>`
                ];
                
                // Add score cells
                criteria.forEach(c => {
                    const score = emp.scores[c.id] || 0;
                    const bgColor = score >= 4 ? 'rgba(45, 134, 89, 0.1)' : 
                                   score >= 3 ? 'rgba(212, 175, 55, 0.1)' : 
                                   score >= 2 ? 'rgba(230, 126, 34, 0.1)' : 
                                   'rgba(192, 57, 43, 0.1)';
                    cells.push(`<td style="background: ${bgColor}; font-weight: 600;">${score.toFixed(1)}</td>`);
                });
                
                // Add action button
                cells.push(`
                    <td>
                        <button class="action-btn" onclick="removeEmployee('${emp.id}')" title="××—×§ ×¢×•×‘×“">
                            ğŸ—‘ï¸
                        </button>
                    </td>
                `);
                
                row.innerHTML = cells.join('');
                tbody.appendChild(row);
            });

            // Show empty state if no employees
            if (employees.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="100" style="text-align: center; padding: 2rem; color: var(--text-light);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ‘¥</div>
                        <div style="font-size: 1.1rem;">×˜×¨× ×”×•×–× ×• ×¢×•×‘×“×™×</div>
                        <div style="font-size: 0.9rem; margin-top: 0.5rem;">×”×©×ª××© ×‘×˜×‘×œ×” ×œ××¢×œ×” ×›×“×™ ×œ×”×•×¡×™×£ ×¢×•×‘×“×™×</div>
                    </td>
                `;
                tbody.appendChild(emptyRow);
            }
        }

        // Render employee scores inputs
        function renderEmployeeScores() {
            const headerContainer = document.getElementById('inputScoresHeader');
            const inputContainer = document.getElementById('inputScoresContainer');
            
            // Create header cells
            headerContainer.innerHTML = '';
            criteria.forEach(c => {
                const th = document.createElement('th');
                th.style.minWidth = '100px';
                th.innerHTML = `${c.name} <span class="required">*</span><br><small style="font-weight: normal; opacity: 0.8;">(1-5)</small>`;
                headerContainer.appendChild(th);
            });
            
            // Create input cells
            inputContainer.innerHTML = '';
            const inputCellsWrapper = document.createElement('div');
            inputCellsWrapper.style.display = 'flex';
            inputCellsWrapper.style.gap = '0.5rem';
            
            criteria.forEach(c => {
                const input = document.createElement('input');
                input.type = 'number';
                input.className = 'form-input';
                input.id = `score_${c.id}`;
                input.min = '1';
                input.max = '5';
                input.step = '0.1';
                input.placeholder = '1-5';
                input.style.margin = '0';
                input.style.width = '90px';
                input.style.textAlign = 'center';
                inputCellsWrapper.appendChild(input);
            });
            
            inputContainer.appendChild(inputCellsWrapper);
        }

        // Validate step 3
        function validateStep3() {
            document.getElementById('step3Next').disabled = employees.length === 0;
        }

        // Handle file upload
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Show loading
            showAlert('success', 'â³ ×§×•×¨× ××ª ×”×§×•×‘×¥...');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { defval: '' });

                    if (!jsonData || jsonData.length === 0) {
                        showAlert('error', '×”×§×•×‘×¥ ×¨×™×§ ××• ×œ× ××›×™×œ × ×ª×•× ×™×');
                        return;
                    }

                    // Get column headers
                    const headers = Object.keys(jsonData[0]);
                    console.log('Headers found:', headers);

                    // Try to identify name column
                    const nameCol = headers.find(h => 
                        h.includes('×©×') || 
                        h.toLowerCase().includes('name') || 
                        h.includes('×¢×•×‘×“')
                    ) || headers[0];

                    // Try to identify ID column
                    const idCol = headers.find(h => 
                        h.includes('×–×”×•×ª') || 
                        h.includes('×ª.×–') || 
                        h.includes('×ª×–') ||
                        h.toLowerCase().includes('id') ||
                        h.toLowerCase().includes('identifier')
                    ) || headers[1];

                    // Try to identify salary column
                    const salaryCol = headers.find(h => 
                        h.includes('××©×›×•×¨×ª') || 
                        h.includes('×©×›×¨') ||
                        h.toLowerCase().includes('salary') ||
                        h.toLowerCase().includes('wage')
                    ) || headers[2];

                    console.log('Detected columns:', { nameCol, idCol, salaryCol });

                    let imported = 0;
                    let skipped = 0;
                    const errors = [];

                    jsonData.forEach((row, index) => {
                        const name = String(row[nameCol] || '').trim();
                        const id = String(row[idCol] || '').trim();
                        const salary = parseFloat(row[salaryCol]) || 0;

                        if (name && id && salary > 0) {
                            // Check for duplicate
                            if (employees.some(e => e.id === id)) {
                                skipped++;
                                errors.push(`×©×•×¨×” ${index + 2}: ×ª.×–. ${id} ×›×‘×¨ ×§×™×™×`);
                            } else {
                                const scores = {};
                                criteria.forEach(c => {
                                    scores[c.id] = 0; // Default scores, can be edited later
                                });
                                employees.push({ name, id, salary, scores });
                                imported++;
                            }
                        } else {
                            skipped++;
                            errors.push(`×©×•×¨×” ${index + 2}: ×—×¡×¨×™× × ×ª×•× ×™× (×©×: ${name || '×—×¡×¨'}, ×ª.×–.: ${id || '×—×¡×¨'}, ××©×›×•×¨×ª: ${salary || '×—×¡×¨'})`);
                        }
                    });

                    // Clear file input
                    document.getElementById('fileInput').value = '';

                    renderEmployeeTable();
                    validateStep3();
                    
                    if (imported > 0) {
                        let message = `âœ“ ${imported} ×¢×•×‘×“×™× ×™×•×‘××• ×‘×”×¦×œ×—×”!`;
                        if (skipped > 0) {
                            message += `\nâš ï¸ ${skipped} ×©×•×¨×•×ª ×“×•×œ×’×•`;
                        }
                        showAlert('success', message);
                        
                        // Show detailed errors in console
                        if (errors.length > 0 && errors.length <= 5) {
                            console.log('×©×•×¨×•×ª ×©×“×•×œ×’×•:', errors);
                            setTimeout(() => {
                                showAlert('warning', `×©×™× ×œ×‘: ${errors.length} ×©×•×¨×•×ª ×“×•×œ×’×•. ×¤×ª×— ××ª ×§×•× ×¡×•×œ ×”××¤×ª×—×™× ×œ×¤×¨×˜×™×.`);
                            }, 3000);
                        }
                    } else {
                        showAlert('error', `×œ× ×™×•×‘××• ×¢×•×‘×“×™×. ×‘×“×•×§ ×©×”×¢××•×“×•×ª ×‘×§×•×‘×¥ ×”×Ÿ: ${nameCol}, ${idCol}, ${salaryCol}`);
                    }
                } catch (error) {
                    console.error('Error reading file:', error);
                    showAlert('error', '×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥: ' + error.message + '. × ×¡×” ×§×•×‘×¥ Excel ××—×¨ ××• ×‘×“×•×§ ×©×”×§×•×‘×¥ ×œ× ×¤×’×•×.');
                }
            };
            
            reader.onerror = function() {
                showAlert('error', '×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥. × ×¡×” ×©×•×‘.');
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Calculate results
        function calculateResults() {
            const totalBudget = baseSettings.totalBaseBudget * (baseSettings.budgetRate / 100);
            
            // Calculate weighted scores
            const totalWeightedScore = employees.reduce((sum, emp) => {
                let weightedScore = 0;
                criteria.forEach(c => {
                    weightedScore += (emp.scores[c.id] || 0) * (c.weight / 100);
                });
                emp.weightedScore = weightedScore;
                return sum + weightedScore;
            }, 0);

            // Calculate promotions
            let totalUsed = 0;
            employees.forEach(emp => {
                // Promotion without limit
                emp.promotionNoLimit = (emp.weightedScore / totalWeightedScore) * totalBudget;
                emp.promotionPercent = (emp.promotionNoLimit / emp.salary) * 100;
                
                // Promotion with 5% limit
                emp.promotionWithLimit = Math.min(emp.salary * 0.05, emp.promotionNoLimit);
                emp.promotionPercentActual = (emp.promotionWithLimit / emp.salary) * 100;
                
                totalUsed += emp.promotionWithLimit;
            });

            return {
                totalBudget,
                totalUsed,
                remaining: totalBudget - totalUsed
            };
        }

        // Render results
        function renderResults() {
            const results = calculateResults();

            document.getElementById('totalBudgetAvailable').textContent = formatCurrency(results.totalBudget);
            document.getElementById('totalBudgetUsed').textContent = formatCurrency(results.totalUsed);
            document.getElementById('budgetRemaining').textContent = formatCurrency(results.remaining);
            document.getElementById('totalEmployees').textContent = employees.length;

            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = '';

            employees.forEach(emp => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${emp.name}</td>
                    <td>${emp.id}</td>
                    <td>${formatNumber(emp.salary)}</td>
                    <td>${emp.weightedScore.toFixed(2)}</td>
                    <td>${formatNumber(emp.promotionNoLimit)}</td>
                    <td>${emp.promotionPercent.toFixed(2)}%</td>
                    <td style="font-weight: 700; color: var(--success);">${formatNumber(emp.promotionWithLimit)}</td>
                    <td style="font-weight: 700; color: var(--success);">${emp.promotionPercentActual.toFixed(2)}%</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Export to PDF
        function exportToPDF() {
            const element = document.querySelector('.container');
            const opt = {
                margin: 10,
                filename: '×ª×§×¦×™×‘_×§×™×“×•×_×¢×•×‘×“×™×.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
            };
            
            showAlert('success', '××™×™×¦× ×œ-PDF...');
            html2pdf().set(opt).from(element).save();
        }

        // Export to Excel
        function exportToExcel() {
            const results = calculateResults();
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Base settings sheet
            const baseData = [
                ['×‘×¡×™×¡ ×œ×—×™×©×•×‘ ×©×›×¨ ×§×™×“×•×'],
                [''],
                ['×©×›×¨ ×‘×’×™×Ÿ ×¨×›×™×‘×™ ×¢×¨×š ×©×¢×”', baseSettings.salaryA],
                ['×©×›×¨ ×‘×’×™×Ÿ ×¢×‘×•×“×” × ×•×¡×¤×ª', baseSettings.salaryB],
                ['×¡×š ×”×›×œ ×ª×§×¦×™×‘ ×”×‘×¡×™×¡', baseSettings.totalBaseBudget],
                ['×”×™×—×¡', baseSettings.ratio],
                ['×©×™×¢×•×¨ ×ª×§×¦×™×‘ ×”×§×™×“×•× (%)', baseSettings.budgetRate],
                ['××§×“× ×”×”×¤×—×ª×”', baseSettings.reductionFactor]
            ];
            const ws1 = XLSX.utils.aoa_to_sheet(baseData);
            XLSX.utils.book_append_sheet(wb, ws1, '×”×’×“×¨×•×ª ×‘×¡×™×¡');
            
            // Criteria sheet
            const criteriaData = [
                ['××“×“×™ ×”×¢×¨×›×”'],
                [''],
                ['×©× ×”××“×“', '××©×§×œ (%)']
            ];
            criteria.forEach(c => {
                criteriaData.push([c.name, c.weight]);
            });
            const ws2 = XLSX.utils.aoa_to_sheet(criteriaData);
            XLSX.utils.book_append_sheet(wb, ws2, '××“×“×™ ×”×¢×¨×›×”');
            
            // Results sheet
            const resultsData = [
                ['×ª×•×¦××•×ª ×—×™×©×•×‘ ×ª×§×¦×™×‘ ×§×™×“×•×'],
                [''],
                ['×¡×š ×ª×§×¦×™×‘ ×–××™×Ÿ', results.totalBudget],
                ['×ª×§×¦×™×‘ ×©×©×™××© ×‘×¤×•×¢×œ', results.totalUsed],
                ['×™×ª×¨×ª ×ª×§×¦×™×‘', results.remaining],
                [''],
                ['×©× ×¢×•×‘×“', '××¡×¤×¨ ×–×”×•×ª', '××©×›×•×¨×ª', '×¦×™×•×Ÿ ××©×•×§×œ×œ', '×ª×§×¦×™×‘ ×œ×œ× ××’×‘×œ×”', '××—×•×– ×§×™×“×•×', '×ª×§×¦×™×‘ ×œ××—×¨ ××’×‘×œ×ª 5%', '××—×•×– ×§×™×“×•× ×‘×¤×•×¢×œ']
            ];
            
            employees.forEach(emp => {
                resultsData.push([
                    emp.name,
                    emp.id,
                    emp.salary,
                    emp.weightedScore,
                    emp.promotionNoLimit,
                    emp.promotionPercent / 100,
                    emp.promotionWithLimit,
                    emp.promotionPercentActual / 100
                ]);
            });
            
            const ws3 = XLSX.utils.aoa_to_sheet(resultsData);
            XLSX.utils.book_append_sheet(wb, ws3, '×ª×•×¦××•×ª');
            
            // Save file
            XLSX.writeFile(wb, '×ª×§×¦×™×‘_×§×™×“×•×_×¢×•×‘×“×™×.xlsx');
            showAlert('success', '×”×§×•×‘×¥ ×™×•×¦× ×‘×”×¦×œ×—×”!');
        }

        // Navigation functions
        function nextStep() {
            if (currentStep === 2) {
                renderEmployeeScores();
            }
            if (currentStep === 3) {
                renderResults();
            }
            
            if (currentStep < 4) {
                currentStep++;
                updateStepDisplay();
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                updateStepDisplay();
            }
        }

        function updateStepDisplay() {
            // Update progress bar
            document.querySelectorAll('.progress-step').forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index + 1 === currentStep) {
                    step.classList.add('active');
                } else if (index + 1 < currentStep) {
                    step.classList.add('completed');
                }
            });

            // Update content
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelector(`.step-content[data-step="${currentStep}"]`).classList.add('active');

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Tab switching
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        // Reset simulator
        function resetSimulator() {
            if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×ª×—×™×œ ××—×“×©? ×›×œ ×”× ×ª×•× ×™× ×™×™××—×§×•.')) {
                location.reload();
            }
        }

        // Utility functions
        function formatNumber(num) {
            return new Intl.NumberFormat('he-IL', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(num);
        }

        function formatCurrency(num) {
            return 'â‚ª' + formatNumber(num);
        }

        function showAlert(type, message) {
            // Remove existing alerts
            document.querySelectorAll('.alert').forEach(a => a.remove());
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <span style="font-size: 1.5rem;">
                    ${type === 'error' ? 'âš ï¸' : type === 'success' ? 'âœ…' : 'â„¹ï¸'}
                </span>
                <span>${message}</span>
            `;
            
            const content = document.querySelector('.step-content.active');
            content.insertBefore(alert, content.firstChild);
            
            setTimeout(() => alert.remove(), 5000);
        }

        // Progress step click handlers
        document.querySelectorAll('.progress-step').forEach((step, index) => {
            step.addEventListener('click', () => {
                const stepNum = index + 1;
                if (stepNum < currentStep || (stepNum === currentStep + 1 && canProceed())) {
                    currentStep = stepNum;
                    updateStepDisplay();
                }
            });
        });

        function canProceed() {
            if (currentStep === 1) {
                return !document.getElementById('step1Next').disabled;
            }
            if (currentStep === 2) {
                return !document.getElementById('step2Next').disabled;
            }
            if (currentStep === 3) {
                return !document.getElementById('step3Next').disabled;
            }
            return true;
        }
    </script>
</body>
</html>
